import{_ as S}from"./csius0aV.js";import{V as A,h as L,e as $,M as g,W as b,f as C,R as T,g as i,w as a,X as O,o as P,b as n,a as U,t as B,d as D}from"./DU_nv6qb.js";import{u as E}from"./Dwcg0_5Q.js";import{u as q}from"./UOf0rom5.js";import{u as z}from"./VBFc3691.js";import{T as I}from"./Bgmjd9F8.js";import{O as M}from"./1d_XzYus.js";import{V as H}from"./epPG9Ibe.js";import{V as x,a as R}from"./DVHrX6do.js";import{V as J}from"./71MGMbUJ.js";import{v as W}from"./BFc9MCJK.js";import"./B5CZD0j7.js";import"./9qXTopoB.js";const X=()=>(A().currentRoute.value.query.code||"").toString(),j=async y=>{const u=L(),m=E();let e="";const c=new URL(m.href),l=[];for(const r of c.searchParams.keys())l.push(r);l.forEach(r=>{c.searchParams.delete(r)});try{const r=await $fetch(`${u.public.issuerUri}/api/login`,{method:"post",body:{code:y,redirect_uri:c.href},parseResponse:h=>(e=h,h)}),d=new M;return d.parseJSON(e),d}catch{throw JSON.parse(e)}},F={class:"text-center"},ce=$({__name:"index",async setup(y){let u,m;const e=g(!0),c=L(),l=A(),r=I.getInstance(),d=r.getTokenByService("graze");d&&r.accessTimeRemaining(d)>0&&(e.value=!1,l.push("/admin/dashboard"));const h=E(),{getState:v}=q();let w=X(),s=v();const p=g(""),k=g(""),_=g();try{_.value=([u,m]=b(()=>z()),u=await u,m(),u),k.value=_.value.AuthorizationEndpoint}catch(t){console.error(t)}const o=new URL(h.href),V=[];return(async()=>{if(s.query!==""&&s.query===s.store)if(!w)s=v(!0);else try{const t=await j(w),f=new URL(_.value.TokenEndpoint);f.pathname="/api/refresh",r.addToken({OAuthToken:t,OAuthConfig:_.value,Vendor:"internal",Endpoint:f.href,Expires:new Date(Date.now()+t.ExpiresIn*1e3).getTime(),Method:"header",Header:"Authorization",HeaderPrefix:"Bearer ",Service:"graze",Timer:void 0}),e.value=!1,l.push("/admin/dashboard")}catch{p.value="Error encountered during login"}else s.store||(s=v(!0));e.value&&!p.value&&(o.searchParams.get("error")==="access_denied"&&o.searchParams.get("error_description")!==""?(e.value=!0,p.value=o.searchParams.get("error_description")||""):(e.value=!1,o.searchParams.delete("code"),o.searchParams.delete("state"),O(`${k.value}?response_type=code&client_id=internal&redirect_uri=${encodeURIComponent(o.href)}&state=${s.store}`,{external:!0})));for(const t of o.searchParams.keys())V.push(t);V.forEach(t=>{o.searchParams.delete(t)})})(),(t,f)=>{const N=S;return i(e)?(P(),C(H,{key:0},{default:a(()=>[n(x,null,{default:a(()=>[n(R,null,{default:a(()=>[U("h1",F,B(i(c).public.organisationName),1)]),_:1})]),_:1}),n(x,null,{default:a(()=>[n(R,null,{default:a(()=>[i(p)?(P(),C(J,{key:0,text:i(p),type:"error",style:{"max-width":"450px"},class:"ma-auto"},null,8,["text"])):T("",!0)]),_:1})]),_:1}),n(x,null,{default:a(()=>[n(R,{class:"text-center"},{default:a(()=>[n(N,{href:`${i(k)}?response_type=code&client_id=internal&redirect_uri=${encodeURIComponent(i(o).href)}&state=${i(s).store}`},{default:a(()=>[n(W,{color:"primary"},{default:a(()=>f[0]||(f[0]=[D("Login")])),_:1})]),_:1},8,["href"])]),_:1})]),_:1})]),_:1})):T("",!0)}}});export{ce as default};
