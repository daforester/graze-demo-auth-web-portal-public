import{_ as E}from"./h1tulNL4.js";import{u as x,L as d,_ as q}from"./CPNF0YJC.js";import{u as b}from"./BwDrwrI2.js";import{u as P}from"./DVVigWha.js";import{e as A,i as N,r as B,j as $,l as z,c as I,o as r,f as u,k as i,w as e,b as t,h as S,m as F,n as U,a as G,t as M,g as C,F as J,d as K}from"./3s1sx6wo.js";import{V as c,a as f}from"./BJXrktLP.js";import{u as O}from"./CVQlkizh.js";import{V as D}from"./BrZF6G-H.js";import{V as j}from"./C9R-QpZI.js";import"./B6dmUYqY.js";import"./D6KsYbGk.js";import"./DM8KnH0J.js";import"./BFI1zpWj.js";import"./BMdyi6GD.js";import"./Dwcg0_5Q.js";import"./CjPOQAt6.js";import"./JhrxTPuU.js";import"./B5CZD0j7.js";const H=A({__name:"LoginButtons",props:{showAmazonLogin:{type:Boolean,default:!1},showEmailLogin:{type:Boolean,default:!1},showFaceBookLogin:{type:Boolean,default:!1},showGoogleLogin:{type:Boolean,default:!1},showInstagramLogin:{type:Boolean,default:!1},showKeycloakLogin:{type:Boolean,default:!1},showMicrosoftLogin:{type:Boolean,default:!1},showSteamLogin:{type:Boolean,default:!1},showTelegramLogin:{type:Boolean,default:!1},showTwitchLogin:{type:Boolean,default:!1},showTwitterLogin:{type:Boolean,default:!1}},emits:["login"],async setup(g,{emit:p}){let n,k;const{addState:_}=P(),L=b(),v=N(),m=B();try{m.value=([n,k]=$(()=>x(`${window.location.origin}${v.resolve("/connect/external").href}`)),n=await n,k(),n)}catch(s){console.error(s)}const y=p,a=B("");return z(a,()=>{var T;const s=(T=m.value)==null?void 0:T.get(a.value);if(!s){y("login",{method:a.value});return}const l=new URL(s).searchParams.get("state");l&&_(l,L),y("login",{method:a.value,uri:s})}),(s,o)=>(r(),I("div",null,[s.showEmailLogin?(r(),u(c,{key:0,dense:!0},{default:e(()=>[t(f,null,{default:e(()=>[t(d,{source:"internal",onClick:o[0]||(o[0]=l=>a.value="internal")})]),_:1})]),_:1})):i("",!0),s.showAmazonLogin?(r(),u(c,{key:1,dense:!0},{default:e(()=>[t(f,null,{default:e(()=>[t(d,{source:"amazon",onClick:o[1]||(o[1]=l=>a.value="amazon")})]),_:1})]),_:1})):i("",!0),s.showFaceBookLogin?(r(),u(c,{key:2,dense:!0},{default:e(()=>[t(f,null,{default:e(()=>[t(d,{source:"facebook",onClick:o[2]||(o[2]=l=>a.value="facebook")})]),_:1})]),_:1})):i("",!0),s.showGoogleLogin?(r(),u(c,{key:3,dense:!0},{default:e(()=>[t(f,null,{default:e(()=>[t(d,{source:"google",onClick:o[3]||(o[3]=l=>a.value="google")})]),_:1})]),_:1})):i("",!0),s.showInstagramLogin?(r(),u(c,{key:4,dense:!0},{default:e(()=>[t(f,null,{default:e(()=>[t(d,{source:"instagram",onClick:o[4]||(o[4]=l=>a.value="instagram")})]),_:1})]),_:1})):i("",!0),s.showMicrosoftLogin?(r(),u(c,{key:5,dense:!0},{default:e(()=>[t(f,null,{default:e(()=>[t(d,{source:"microsoft",onClick:o[5]||(o[5]=l=>a.value="microsoft")})]),_:1})]),_:1})):i("",!0),s.showSteamLogin?(r(),u(c,{key:6,dense:!0},{default:e(()=>[t(f,null,{default:e(()=>[t(d,{source:"steam",onClick:o[6]||(o[6]=l=>a.value="steam")})]),_:1})]),_:1})):i("",!0),s.showTelegramLogin?(r(),u(c,{key:7,dense:!0},{default:e(()=>[t(f,null,{default:e(()=>[t(d,{source:"telegram"})]),_:1})]),_:1})):i("",!0),s.showTwitchLogin?(r(),u(c,{key:8,dense:!0},{default:e(()=>[t(f,null,{default:e(()=>[t(d,{source:"twitch",onClick:o[7]||(o[7]=l=>a.value="twitch")})]),_:1})]),_:1})):i("",!0),s.showTwitterLogin?(r(),u(c,{key:9,dense:!0},{default:e(()=>[t(f,null,{default:e(()=>[t(d,{source:"twitter",onClick:o[8]||(o[8]=l=>a.value="twitter")})]),_:1})]),_:1})):i("",!0),s.showKeycloakLogin?(r(),u(c,{key:10,dense:!0},{default:e(()=>[t(f,null,{default:e(()=>[t(d,{source:"keycloak",onClick:o[9]||(o[9]=l=>a.value="keycloak")})]),_:1})]),_:1})):i("",!0)]))}}),Q=()=>{try{const g=N(),p=g.currentRoute.value.query.state||"",n=new URL(g.currentRoute.value.query.redirect_uri||"");return n.searchParams.set("state",p),n.toString()}catch(g){console.error(g)}return""},W=async g=>{const p=S();try{return await $fetch(`${p.public.issuerUri}/connect/style/${g}`,{method:"get",parseResponse:n=>{try{return JSON.parse(n)}catch{throw n}}})}catch{return{}}},X=async g=>{const p=S(),{getAccessToken:n,storeAccessToken:k,storeRefreshToken:_}=O();let L="";try{L=await n()}catch{throw new Error("no access token available")}try{return await $fetch(`${p.public.issuerUri}/connect/auth/token`,{method:"post",body:JSON.stringify({oauth:g,access_token:L,new:!1}),parseResponse:v=>{const m=JSON.parse(v);return m.AccessToken&&k(m.AccessToken),m.RefreshToken&&_(m.RefreshToken),{RedirectURI:m.RedirectURI||"",Existing:m.Existing||!1}}})}catch(v){throw v}},Y={class:"text-center"},ye=A({__name:"auth",emits:["pageTitle"],async setup(g,{emit:p}){let n,k;const _=S(),{getAccessToken:L}=O();p("pageTitle","Login");const m=Q(),y=B("BUTTONS"),a=async()=>{try{if(F().query.state){const w=b(),R=await X(w);R&&(new URL(R).searchParams.get("error")||U(R,{external:!0}))}}catch{}};let s;try{s=([n,k]=$(()=>L()),n=await n,k(),n),s&&a()}catch{}const o=({method:h,uri:w})=>{switch(h){case"internal":y.value="INTERNAL_LOGIN";break;case"keycloak":U(w,{external:!0});break}},l=N(),T=([n,k]=$(()=>W(l.currentRoute.value.query.client_id)),n=await n,k(),n);if(T){const h=document.createElement("style");h.textContent=T.css,document.head.append(h)}return(h,w)=>{const R=E;return r(),u(D,null,{default:e(()=>[G("h1",Y,M(C(_).public.organisationName),1),C(y)=="BUTTONS"?(r(),I(J,{key:0},[t(H,{showEmailLogin:!0,showKeycloakLogin:!0,showTelegramLogin:!0,onLogin:o,style:{"max-width":"250px"},class:"ma-auto mb-5"}),t(c,null,{default:e(()=>[t(f,{class:"pa-0 text-center"},{default:e(()=>[t(R,{href:C(m)},{default:e(()=>[t(j,{variant:"text"},{default:e(()=>w[1]||(w[1]=[K(" Cancel ")])),_:1})]),_:1},8,["href"])]),_:1})]),_:1})],64)):C(y)=="INTERNAL_LOGIN"?(r(),u(q,{key:1,onCancel:w[0]||(w[0]=V=>y.value="BUTTONS")})):i("",!0)]),_:1})}}});export{ye as default};
