import{_ as N}from"./DNvhtt3t.js";import{i as A,h as L,e as S,r as g,j as $,f as C,k as T,g as i,w as a,n as O,o as P,b as n,a as U,t as B,d as D}from"./9q-fxqZG.js";import{u as b}from"./Dwcg0_5Q.js";import{u as q}from"./3xsYz4tu.js";import{u as z}from"./3G9Ljq4J.js";import{T as I}from"./BzPJC3u6.js";import{O as M}from"./C8xSek-N.js";import{V as H}from"./BAQfXbzc.js";import{V as x,a as w}from"./D_6uU0M2.js";import{V as J}from"./LS80WArn.js";import{V as j}from"./C1XXGx0e.js";import"./B5CZD0j7.js";import"./Ci-VC6dV.js";const F=()=>(A().currentRoute.value.query.code||"").toString(),G=async y=>{const c=L(),m=b();let e="";const u=new URL(m.href),l=[];for(const r of u.searchParams.keys())l.push(r);l.forEach(r=>{u.searchParams.delete(r)});try{const r=await $fetch(`${c.public.issuerUri}/api/login`,{method:"post",body:{code:y,redirect_uri:u.href},parseResponse:h=>(e=h,h)}),d=new M;return d.parseJSON(e),d}catch{throw JSON.parse(e)}},K={class:"text-center"},ue=S({__name:"index",async setup(y){let c,m;const e=g(!0),u=L(),l=A(),r=I.getInstance(),d=r.getTokenByService("graze");d&&r.accessTimeRemaining(d)>0&&(e.value=!1,l.push("/admin/dashboard"));const h=b(),{getState:v}=q();let R=F(),s=v();const p=g(""),k=g(""),_=g();try{_.value=([c,m]=$(()=>z()),c=await c,m(),c),k.value=_.value.AuthorizationEndpoint}catch(t){console.error(t)}const o=new URL(h.href),V=[];return(async()=>{if(s.query!==""&&s.query===s.store)if(!R)s=v(!0);else try{const t=await G(R),f=new URL(_.value.TokenEndpoint);f.pathname="/api/refresh",r.addToken({OAuthToken:t,OAuthConfig:_.value,Vendor:"internal",Endpoint:f.href,Expires:new Date(Date.now()+t.ExpiresIn*1e3).getTime(),Method:"header",Header:"Authorization",HeaderPrefix:"Bearer ",Service:"graze",Timer:void 0}),e.value=!1,l.push("/admin/dashboard")}catch{p.value="Error encountered during login"}else s.store||(s=v(!0));e.value&&!p.value&&(o.searchParams.get("error")==="access_denied"&&o.searchParams.get("error_description")!==""?(e.value=!0,p.value=o.searchParams.get("error_description")||""):(e.value=!1,o.searchParams.delete("code"),o.searchParams.delete("state"),O(`${k.value}?response_type=code&client_id=internal&redirect_uri=${encodeURIComponent(o.href)}&state=${s.store}&scope=openid+profile+email+badge_serial+convention_references+convention_tags`,{external:!0})));for(const t of o.searchParams.keys())V.push(t);V.forEach(t=>{o.searchParams.delete(t)})})(),(t,f)=>{const E=N;return i(e)?(P(),C(H,{key:0},{default:a(()=>[n(x,null,{default:a(()=>[n(w,null,{default:a(()=>[U("h1",K,B(i(u).public.organisationName),1)]),_:1})]),_:1}),n(x,null,{default:a(()=>[n(w,null,{default:a(()=>[i(p)?(P(),C(J,{key:0,text:i(p),type:"error",style:{"max-width":"450px"},class:"ma-auto"},null,8,["text"])):T("",!0)]),_:1})]),_:1}),n(x,null,{default:a(()=>[n(w,{class:"text-center"},{default:a(()=>[n(E,{href:`${i(k)}?response_type=code&client_id=internal&redirect_uri=${encodeURIComponent(i(o).href)}&state=${i(s).store}`},{default:a(()=>[n(j,{color:"primary"},{default:a(()=>[...f[0]||(f[0]=[D("Login",-1)])]),_:1})]),_:1},8,["href"])]),_:1})]),_:1})]),_:1})):T("",!0)}}});export{ue as default};
